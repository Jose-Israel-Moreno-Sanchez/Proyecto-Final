###############################################################################
# ğŸ³ TianguiStore â€“ Dockerfile para NGINX con plantilla dinÃ¡mica
# -----------------------------------------------------------------------------
# Este Dockerfile genera una imagen personalizada de NGINX que:
# - Usa la imagen oficial `nginx:stable-alpine`
# - Soporta plantillas dinÃ¡micas con variables de entorno
# - Aplica `envsubst` automÃ¡ticamente al inicio
# - Corresponde con entradas seÃ±aladas en el docker-compose.yml
###############################################################################

# ğŸ¯ 1. Imagen base ligera y estable
FROM nginx:stable-alpine

# ğŸ”§ 2. Instalar herramientas necesarias (gettext para envsubst)
RUN apk add --no-cache gettext bash

# ğŸ§­ 3. Crear directorio para plantillas si no existe
RUN mkdir -p /etc/nginx/templates

# ğŸ§± 4. Copiar plantilla de configuraciÃ³n (se generarÃ¡ default.conf en runtime)
COPY default.conf.template /etc/nginx/templates/default.conf.template

# âš™ï¸ 5. Copiar cualquier otro ajuste adicional si se requiere
# (Por ej., SSL, mÃ³dulos personalizados, favicon, html)
# COPY extra.conf /etc/nginx/conf.d/extra.conf

# ğŸ” 6. Exponer el puerto HTTP
EXPOSE 80

# ğŸš€ 7. ENTRYPOINT que aplica envsubst y despliega NGINX en primer plano
ENTRYPOINT ["/bin/sh", "-c", "\
  echo 'ğŸ‘‰ Generando configuraciÃ³n de NGINX a partir de templateâ€¦'; \
  envsubst '$$NGINX_PORT $$NGINX_SERVER_NAME $$expires_cssjs $$cache_cssjs $$expires_img $$cache_img' \
    < /etc/nginx/templates/default.conf.template \
    > /etc/nginx/conf.d/default.conf; \
  echo 'âœ… Config generada, iniciando NGINXâ€¦'; \
  exec nginx -g 'daemon off;'"]
